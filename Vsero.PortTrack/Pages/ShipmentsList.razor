@page "/shipmentsList"
@using Vsero.PortTrack.Components
@using Vsero.UTrcak.V1
@inject ApiClient Api
@inject UserContext UserContext
@inherits PortTrackComponentBase




<MudContainer MaxWidth="MaxWidth.Small" Class="pa-4">

    <PageLoading IsLoading="@_isLoading" />
    <ErrorAlertBar ErrorMessage="@_errorMessage" />

    <MudStack Spacing="1">
        @foreach (var shipment in _shipments)
        {
            <ShipmentCard Shipment="shipment" IsExpandable="true" OnDelete="DeleteShipment"/>
        }
    </MudStack>

</MudContainer>




@code {

    private bool _isLoading;
    private string _errorMessage = string.Empty;
    private List<CargoShipment> _shipments = [];



    protected override Task OnInitializedAsync()
    {
        _ = GetShipments();
        return base.OnInitializedAsync();
    }



    private async Task GetShipments()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        _shipments.Clear();

        IEnumerable<CargoShipment>? cargoShipments = null;
        var apiTguser = ApiTguser();
        if (apiTguser is not null)
        {
            (cargoShipments, _errorMessage) = await Api.NotifyShipmentGetAsync(apiTguser, CancellationToken());
        }

        if (cargoShipments is not null)
            _shipments = cargoShipments.ToList();

        _isLoading = false;
        StateHasChanged();
    }



    private async Task DeleteShipment(CargoShipment shipment)
    {

        var apiTguser = ApiTguser();
        if (apiTguser is not null)
        {
            // (cargoShipments, _errorMessage) = await Api.NotifyShipmentGET(apiTguser, CancellationToken());
        }

    }



    private Vsero.UTrcak.TgUser? ApiTguser()
    {
        return new()
            {
                Id = 412798134,
                Username = "VitalySerokurov",
                FirstName = "Vitaly"
            };

        //return UserContext.TgUser?.ToApiModel();
    }


}