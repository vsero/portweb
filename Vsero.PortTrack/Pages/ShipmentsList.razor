@page "/shipmentsList"
@using Vsero.PortTrack.Components
@using Vsero.UTrcak.V1
@inject ApiClient Api
@inject UserContext UserContext
@inherits PortTrackComponentBase



<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">

    <PageLoading IsLoading="@_isLoading" />
    <ErrorAlertBar ErrorMessage="@_errorMessage" />

    <MudStack Spacing="1">
        @foreach (var shipment in _shipments)
        {
            <ShipmentCard @key="shipment" Shipment="shipment" IsExpandable="true">
                <CardActions>
                    <MudSpacer />
                    <ShipmentCardButton OnClick="@(() => ShipmentCard_Delete(shipment))" Kind="ShipmentCardButton.ButtonKind.Delete" />
                </CardActions>
            </ShipmentCard>
        }
    </MudStack>

</MudContainer>




@code {

    private bool _isLoading;
    private string _errorMessage = string.Empty;
    private List<CargoShipment> _shipments = [];



    protected override Task OnInitializedAsync()
    {
        _ = GetShipments();
        return base.OnInitializedAsync();
    }



    private async Task GetShipments()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        _shipments.Clear();

        IEnumerable<CargoShipment>? cargoShipments = null;
        var apiTguser = UserContext.ApiTguser();
        if (apiTguser is not null)
        {
            (cargoShipments, _errorMessage) = await Api.NotifyShipmentGetAsync(apiTguser, CancellationToken());
        }

        if (cargoShipments is not null)
            _shipments = cargoShipments.ToList();

        _isLoading = false;
        StateHasChanged();
    }



    private async Task ShipmentCard_Delete(CargoShipment shipment)
    { 
        bool result = false;
        var apiTguser = UserContext.ApiTguser();
        if (apiTguser is not null)
        {
            (result, _errorMessage) = await Api.NotifyShipmentDeleteAsync(apiTguser, shipment, CancellationToken());
        }

        if (_shipments.Contains(shipment))
            _shipments.Remove(shipment);
    }

}