@inherits LayoutComponentBase
@using Microsoft.Extensions.Localization
@using MudBlazor.Services
@using System.Text.Json
@using LP = Vsero.PortTrack.Resources.LMainLayout
@inject IBrowserViewportService ViewportService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject UserContext UserContext
<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@UserContext.IsDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>

    @* Широкий экран *@
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudAppBar>
            <MudText Typo="Typo.h6">@LP.AppBarTitle</MudText>
            <MudSpacer />
            @LanguageSelectMenu
        </MudAppBar>
        <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2">
            <MudNavMenu>
                <MudNavLink href="shipmentSearch" Icon="@_iconPage_shipmentSearch">@LP.PageShipmentSearch</MudNavLink>
                @if (UserContext.IsTg)
                {
                    <MudNavLink href="shipmentsList" Icon="@Icons.Material.Filled.ListAlt">@LP.PageShipmentList</MudNavLink>
                }
                <MudNavLink href="vessels" Icon="@_iconPage_vessels">@LP.PageVessels</MudNavLink>
            </MudNavMenu>
        </MudDrawer>
    </MudHidden>

    @* Узкий экран *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudAppBar Bottom="true" Fixed="true">
            <MudSpacer />
            <MudIconButton Icon="@_iconPage_shipmentSearch" href="shipmentSearch" />
            @if (UserContext.IsTg)
            {
                <MudSpacer />
                <MudIconButton Icon="@_iconPage_shipmentList" href="shipmentList" />
            }
            <MudSpacer />
            <MudIconButton Icon="@_iconPage_vessels" href="vessels" />
            <MudSpacer />
            @LanguageSelectMenu
            <MudSpacer />
        </MudAppBar>
    </MudHidden>

    <MudMainContent Class="pt-0 pb-16 pt-md-16 pb-md-0">
        @Body
    </MudMainContent>

</MudLayout>

@code {


    private string _iconPage_shipmentSearch = Icons.Material.Filled.Search;
    private string _iconPage_shipmentList = Icons.Material.Filled.ListAlt;
    private string _iconPage_vessels = Icons.Material.Filled.DirectionsBoat;


    #region RenderFragments

    private RenderFragment LanguageSelectMenu => __builder =>
    {
        <MudMenu Icon="@Icons.Material.Filled.Language" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem OnClick="@(() => ChangeLanguage("ru-RU"))">
                <div class="d-flex align-center">
                    <span class="mr-2">🇷🇺</span> Русский
                </div>
            </MudMenuItem>
            <MudMenuItem OnClick="@(() => ChangeLanguage("en-US"))">
                <div class="d-flex align-center">
                    <span class="mr-2">🇺🇸</span> English
                </div>
            </MudMenuItem>
        </MudMenu>
    };

    #endregion

    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _theme = Themes.DefaultTheme;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetupUserContext();
            StateHasChanged();
        }
    }

    private async Task SetupUserContext()
    {
        if (_mudThemeProvider is not null)
        {
            var currentBreakpoint = await ViewportService.GetCurrentBreakpointAsync();
            UserContext.IsMobile = currentBreakpoint <= Breakpoint.Sm;
            UserContext.IsDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
        }
    }

    private async Task ChangeLanguage(string culture)
    {
        if (UserContext.Culture != culture)
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "selectedCulture", culture);
            // Nav.NavigateTo(Nav.Uri, forceLoad: true);
            await JS.InvokeVoidAsync("location.reload");
        }
    }



}