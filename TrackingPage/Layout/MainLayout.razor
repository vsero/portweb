@inherits LayoutComponentBase
@using MudBlazor.Services
@using System.Text.Json
@inject IBrowserViewportService ViewportService
@inject IJSRuntime JS
<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@UserContext.IsDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>

    @* Виден только на широких экранах (ПК) *@
   <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudAppBar>Tracking</MudAppBar>
        <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2">
            <MudNavMenu>
                <MudNavLink href="tracking" Icon="@Icons.Material.Filled.Search">Трекинг</MudNavLink>
                <MudNavLink href="vessels" Icon="@Icons.Material.Filled.DirectionsBoat">Суда</MudNavLink>
            </MudNavMenu>
        </MudDrawer>
    </MudHidden>

    @* Виден только на узких экранах (Мобилки/Telegram) *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudAppBar Bottom="true" Fixed="true">
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Search" href="tracking" />
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.DirectionsBoat" href="vessels" />
            <MudSpacer />
        </MudAppBar>
    </MudHidden>
    
    <MudMainContent Class="pt-0 pt-md-16">
        <CascadingValue Value="UserContext">
            @Body
        </CascadingValue>
    </MudMainContent>

</MudLayout>

@code {

    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _theme = Themes.DefaultTheme;
    private UserContext UserContext = new UserContext();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetupUserContext();
            StateHasChanged();
        }
    }

    #region Setup User Context

    private async Task SetupUserContext()
    {
        if (_mudThemeProvider is not null)
        {
            var currentBreakpoint = await ViewportService.GetCurrentBreakpointAsync();
            UserContext.IsMobile = currentBreakpoint <= Breakpoint.Sm;
            UserContext.IsDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
        }
        await SetupTelegramContext();
    }

    private async Task SetupTelegramContext()
    {
        try
        {
            var jsonData = await JS.InvokeAsync<string>("getTelegramData");
            if (!string.IsNullOrEmpty(jsonData))
            {
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.SnakeCaseLower
                };
                var tgData = JsonSerializer.Deserialize<TgInitData>(jsonData, options);

                if (tgData?.User != null)
                {
                    UserContext.IsTg = true;
                    UserContext.TgUser = tgData.User;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка Telegram SDK: {ex.Message}");
        }
        
    }

    #endregion

}