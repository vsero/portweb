@inherits LayoutComponentBase
@using MudBlazor.Services
@using System.Text.Json
@inject IBrowserViewportService ViewportService
@inject IJSRuntime JS
<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@UserContext.IsDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <CascadingValue Value="UserContext">
        @Body
    </CascadingValue>
</MudLayout>

@* <MudLayout>
    @if (_isMobile)
    {
        <MudAppBar Bottom="true" Fixed="true" Color="Color.Primary" Elevation="4">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerOpen = !DrawerOpen)" />
            <MudSpacer />
            <MudText Typo="Typo.h6" Class="flex-grow-1 text-center">PortWeb</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" />
        </MudAppBar>
    }
    else
    {
        <MudAppBar Fixed="true" Color="Color.Primary" Elevation="1">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerOpen = !DrawerOpen)" />
            <MudText Typo="Typo.h6" Class="ml-3">Tracking Project 2026</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
            <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit" />
        </MudAppBar>
    }

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout> *@

@code {

    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _theme = Themes.DefaultTheme;
    private UserContext UserContext = new UserContext();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetupUserContext();
            StateHasChanged();
        }
    }

    #region Setup User Context

    private async Task SetupUserContext()
    {
        if (_mudThemeProvider is not null)
        {
            var currentBreakpoint = await ViewportService.GetCurrentBreakpointAsync();
            UserContext.IsMobile = currentBreakpoint <= Breakpoint.Sm;
            UserContext.IsDarkMode = await _mudThemeProvider.GetSystemDarkModeAsync();
        }
        await SetupTelegramContext();
    }

    private async Task SetupTelegramContext()
    {
        try
        {
            var jsonData = await JS.InvokeAsync<string>("getTelegramData");
            if (!string.IsNullOrEmpty(jsonData))
            {
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.SnakeCaseLower
                };
                var tgData = JsonSerializer.Deserialize<TgInitData>(jsonData, options);

                if (tgData?.User != null)
                {
                    UserContext.IsTg = true;
                    UserContext.TgUser = tgData.User;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка Telegram SDK: {ex.Message}");
        }
        
    }

    #endregion

}